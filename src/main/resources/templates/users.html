<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users - BakeryWebsite</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
<!-- Header -->
<header class="bg-stone-500 text-white p-4">
    <div class="container mx-auto flex justify-between items-center">
        <h1 class="text-2xl font-bold">BakeryWebsite</h1>
        <nav id="navLinks">
            <a href="index.html" class="px-2 hover:underline">Home</a>
            <a href="register.html" class="px-2 hover:underline">Register</a>
            <a href="login.html" class="px-2 hover:underline">Login</a>
            <a href="#" id="logout" class="px-2 hover:underline hidden">Logout</a>
        </nav>
    </div>
</header>

<!-- Main Content -->
<main class="container mx-auto p-4">
    <h2 class="text-3xl font-bold mb-4">Users</h2>
    <p class="mb-4">List of all registered users.</p>
    <table class="w-full bg-white shadow-md rounded">
        <thead>
        <tr class="bg-gray-200">
            <th class="p-2 text-left">ID</th>
            <th class="p-2 text-left">Username</th>
            <th class="p-2 text-left">Role</th>
            <th class="p-2 text-left">Actions</th>
        </tr>
        </thead>
        <tbody id="userTable">
        <!-- Users will be populated here -->
        </tbody>
    </table>
</main>

<!-- Footer -->
<footer class="bg-stone-500 text-white p-4">
    <div class="container mx-auto text-center">
        <p>Contact: info@bakerywebsite.com | Â© 2025 BakeryWebsite</p>
    </div>
</footer>

<script>
    // Check if user is logged in and has admin role
    const user = localStorage.getItem('user');
    const navLinks = document.getElementById('navLinks');
    const logoutLink = document.getElementById('logout');

    if (!user) {
        window.location.href = 'login.html';
    } else {
        const userObj = JSON.parse(user);
        if (userObj.role !== 'ADMIN') {
            alert('Access denied: Admins only');
            window.location.href = 'index.html';
        } else {
            // Show logout link and Users link for admins
            logoutLink.classList.remove('hidden');
            // Hide login and register links
            Array.from(navLinks.children).forEach(link => {
                if (link.textContent === 'Login' || link.textContent === 'Register') {
                    link.classList.add('hidden');
                }
            });
            // Add Users link
            const usersLink = document.createElement('a');
            usersLink.href = 'users.html';
            usersLink.className = 'px-2 hover:underline';
            usersLink.textContent = 'Users';
            navLinks.insertBefore(usersLink, logoutLink);
        }
    }

    // Fetch and display users
    function loadUsers() {
        fetch('http://localhost:8080/api/users')
            .then(response => response.json())
            .then(users => {
                const userTable = document.getElementById('userTable');
                userTable.innerHTML = users.map(user => `
                    <tr id="user-${user.id}">
                        <td class="p-2">${user.id}</td>
                        <td class="p-2">
                            <span class="view-mode">${user.username}</span>
                            <input type="text" class="edit-mode hidden w-full p-1 border rounded" value="${user.username}">
                        </td>
                        <td class="p-2">
                            <span class="view-mode">${user.role}</span>
                            <select class="edit-mode hidden w-full p-1 border rounded">
                                <option value="CUSTOMER" ${user.role === 'CUSTOMER' ? 'selected' : ''}>Customer</option>
                                <option value="ADMIN" ${user.role === 'ADMIN' ? 'selected' : ''}>Admin</option>
                            </select>
                        </td>
                        <td class="p-2">
                            <button onclick="toggleEdit(${user.id})" class="bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 view-mode">Edit</button>
                            <button onclick="saveUser(${user.id})" class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 edit-mode hidden">Save</button>
                            <button onclick="deleteUser(${user.id})" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Delete</button>
                        </td>
                    </tr>
                `).join('');
            })
            .catch(error => console.error('Error fetching users:', error));
    }

    // Toggle edit mode
    function toggleEdit(userId) {
        const row = document.getElementById(`user-${userId}`);
        row.querySelectorAll('.view-mode').forEach(el => el.classList.toggle('hidden'));
        row.querySelectorAll('.edit-mode').forEach(el => el.classList.toggle('hidden'));
    }

    // Save updated user
    async function saveUser(userId) {
        const row = document.getElementById(`user-${userId}`);
        const username = row.querySelector('input').value;
        const role = row.querySelector('select').value;

        try {
            const response = await fetch(`http://localhost:8080/api/users/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, role })
            });
            if (response.ok) {
                toggleEdit(userId);
                loadUsers(); // Refresh table
            } else {
                alert('Failed to update user');
            }
        } catch (err) {
            alert('Error connecting to server');
        }
    }

    // Delete user
    async function deleteUser(userId) {
        if (confirm('Are you sure you want to delete this user?')) {
            try {
                const response = await fetch(`http://localhost:8080/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    loadUsers(); // Refresh table
                } else {
                    alert('Failed to delete user');
                }
            } catch (err) {
                alert('Error connecting to server');
            }
        }
    }

    // Logout
    document.getElementById('logout').addEventListener('click', () => {
        localStorage.removeItem('user');
        window.location.href = 'login.html';
    });

    // Initial load
    loadUsers();
</script>
</body>
</html>